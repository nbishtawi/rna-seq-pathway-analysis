---
title: "minimal_rna_seq_R_pipeline"
author: "Nadeem Bishtawi"
date: "2025-06-06"
output: pdf_document
---

```{r setup, warning=FALSE, message = FALSE, include=FALSE}
library(tidyverse)
library(DESeq2)
library(clusterProfiler)
library(org.Mm.eg.db)
library(AnnotationDbi)
library(EnhancedVolcano)
library(pheatmap)
library(purrr)
```

## Introduction

This analysis demonstrates a minimal but functional RNA-seq differential expression workflow in R. Using gene expression counts from control and irradiated mouse salivary gland tissues, we identify differentially expressed genes (DEGs) with DESeq2 and perform KEGG pathway enrichment using clusterProfiler. The objective is to explore transcriptomic changes induced by radiation exposure, examine enriched biological pathways, and provide a reference point for comparison with results generated through an equivalent Python-based pipeline.

## 1. Data Import

In this step, we load raw gene count files for three untreated (control) and three irradiated samples. Each file contains raw Ensembl gene counts.

```{r echo=TRUE}
# Load count files from data/raw/
files <- list.files("../data/raw/", pattern = "GSM.*\\.txt$", full.names = TRUE)
sample_names <- c("UT1", "UT2", "UT3", "IR1", "IR2", "IR3")
names(files) <- sample_names

# Read each count file and merge them on Ensembl gene ID
count_list <- lapply(files, function(f) read_tsv(f, col_names = c("Ensembl", "Count"), show_col_types = FALSE))
counts_merged <- purrr::reduce(count_list, function(x, y) inner_join(x, y, by = "Ensembl"))
colnames(counts_merged) <- c("Ensembl", sample_names)

# Convert to matrix and set row names
count_matrix <- counts_merged %>%
  column_to_rownames("Ensembl") %>%
  as.matrix()
```
### Notes on Input and Output Files

- **Input**: RNA-seq read count files are stored in the `../data/raw/` directory. Each file represents a single biological replicate and contains raw Ensembl gene counts. Files are named using the pattern `GSM*.txt` (e.g., `GSM1.txt`, `GSM2.txt`, etc.), and are read into R using `read_tsv()`.

- **Output**:
  - Differential expression results: `../results/deseq2_results_R.csv`
  - KEGG enrichment results: `../results/kegg_enrichment_R.csv`
  - Figures:
    - Volcano plot: `../figures/volcano_plot_R.png`
    - KEGG barplot: `../figures/kegg_barplot_R.png`
    - Heatmap of top variable genes: `../figures/heatmap_top30_genes_R.png`
    - PCA plot: `../figures/pca_plot_R.png`
    - Sample distance heatmap: `../figures/sample_distance_heatmap_R.png`



## 2. DESeq2 Differential Expression Analysis

We perform normalization and differential expression analysis using DESeq2. This step models the count data and estimates log2 fold changes and p-values between control and irradiated conditions.

```{r echo=TRUE}
# Define condition metadata
coldata <- data.frame(
  condition = factor(c(rep("Control", 3), rep("Irradiated", 3))),
  row.names = sample_names
)

# Build DESeq2 object and run the pipeline
dds <- DESeqDataSetFromMatrix(countData = count_matrix,
                              colData = coldata,
                              design = ~ condition)
dds <- dds[rowSums(counts(dds)) > 10, ]  # Filter low-count genes
dds <- DESeq(dds)
vsd <- vst(dds, blind = FALSE)

# Extract results
res <- results(dds, contrast = c("condition", "Irradiated", "Control"))
res_df <- as.data.frame(res) %>%
  rownames_to_column("Ensembl") %>%
  arrange(padj)

# Save results
write.csv(res_df, "../results/deseq2_results_R.csv")
```

## 3. Volcano Plot of DEGs

We use EnhancedVolcano to visualize DEGs. This highlights genes with both large fold changes and statistical significance.

```{r echo=TRUE}
# Add gene symbols to results dataframe
suppressWarnings({
  res_df$symbol <- mapIds(org.Mm.eg.db,
                          keys = res_df$Ensembl,
                          column = "SYMBOL",
                          keytype = "ENSEMBL",
                          multiVals = "first")
})

# Use Ensembl ID as fallback label if gene symbol is missing
res_df$label <- ifelse(is.na(res_df$symbol), res_df$Ensembl, res_df$symbol)

# Basic EnhancedVolcano plot

volcano <- EnhancedVolcano(
  res_df,
  lab = res_df$label,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = 'Irradiated vs Control',
  subtitle = 'EnhancedVolcano',
  pCutoff = 0.05,
  FCcutoff = 1.5,
  pointSize = 2.0,
  labSize = 4.5,
  legendPosition = 'top',
  legendLabSize = 12,
  legendIconSize = 4,
  drawConnectors = TRUE,
  widthConnectors = 0.5,
  colAlpha = 0.75,
)

ggsave("../figures/volcano_plot_R.png", volcano, width = 8, height = 6)
```


## 4. Map Ensembl IDs to Entrez IDs

To use clusterProfiler for KEGG enrichment, we must convert Ensembl gene IDs to Entrez IDs using org.Mm.eg.db.


```{r echo=TRUE}
res_df$entrez <- mapIds(org.Mm.eg.db,
                        keys = res_df$Ensembl,
                        column = "ENTREZID",
                        keytype = "ENSEMBL",
                        multiVals = "first")

# Filter for significantly DE genes with valid Entrez IDs
sig_genes <- res_df %>%
  filter(padj < 0.05 & abs(log2FoldChange) > 1) %>%
  pull(entrez) %>%
  na.omit()
```
```{r}
# Count how many failed mappings
sum(is.na(res_df$entrez))

# View a sample of failed Ensembl IDs
head(res_df$Ensembl[is.na(res_df$entrez)])

```
## 5. KEGG Pathway Enrichment

Using enrichKEGG, we identify biological pathways enriched among significantly differentially expressed genes.

```{r echo=TRUE}
kegg <- enrichKEGG(
  gene         = sig_genes,
  organism     = "mmu",   # 'mmu' is the KEGG code for mouse
  pvalueCutoff = 0.05
)

# Save results to CSV
write.csv(as.data.frame(kegg), "../results/kegg_enrichment_R.csv", row.names = FALSE)
```

## 6. Visualize Top KEGG Pathways

This barplot displays the top 10 enriched KEGG pathways based on adjusted p-values.

```{r echo=TRUE}
bar <- barplot(kegg, showCategory = 10, title = "Top Enriched KEGG Pathways")
ggsave("../figures/kegg_barplot_R.png", plot = bar, width = 8, height = 6)
```

## 7. Heatmap of Highly Variable Genes

We display a heatmap of the top 30 most variable genes across all samples to visualize sample clustering and expression patterns.

```{r echo=TRUE}
vsd <- vst(dds, blind = FALSE)
top_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 30)

mat <- assay(vsd)[top_genes, ]
mat <- mat - rowMeans(mat)

heatmap <- pheatmap(mat, cluster_rows = TRUE, cluster_cols = TRUE)
ggsave("../figures/heatmap_top30_genes_R.png", plot = heatmap[[4]], width = 7, height = 6)
```

## 8. Data Quality Control


```{r echo=TRUE}
# PCA plot to visualize global sample differences
pca_data <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
percentVar <- round(100 * attr(pca_data, "percentVar"))

p <- ggplot(pca_data, aes(PC1, PC2, color = condition)) +
  geom_point(size = 3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  ggtitle("PCA of Sample Gene Expression")

ggsave("../figures/pca_plot_R.png", p, width = 7, height = 6)
```

```{r echo=TRUE}
sample_dists <- dist(t(assay(vsd)))
pheatmap(as.matrix(sample_dists),
         main = "Sample-to-Sample Distance Heatmap",
         filename = "../figures/sample_distance_heatmap_R.png")
```
### Interpretation of Quality Control Results

The PCA plot of variance-stabilized gene expression data shows clear separation between control and irradiated samples, indicating that radiation exposure drives distinct transcriptomic profiles. Principal Component 1 (PC1) explains 47% of the total variance and primarily distinguishes the two experimental conditions. This supports the validity of the differential expression analysis.

The sample-to-sample distance heatmap reinforces this conclusion. Control samples (UT1–UT3) cluster more closely with each other, while irradiated samples (IR1–IR3) form a separate group. One irradiated sample (IR2) shows a slightly greater distance from its group, which may reflect biological or technical variability. Nonetheless, the overall clustering structure supports good data quality and consistency within conditions.


## 9. Session Info
```{r}
sessionInfo()
```