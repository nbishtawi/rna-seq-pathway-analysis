---
title: "minimal_deseq2_clusterprofiler_pipeline"
author: "Nadeem Bishtawi"
date: "2025-06-06"
output: pdf_document
---

```{r setup, warning=FALSE, message = FALSE, include=FALSE}
library(tidyverse)
library(DESeq2)
library(clusterProfiler)
library(org.Mm.eg.db)
library(AnnotationDbi)
library(EnhancedVolcano)
library(pheatmap)
library(purrr)
```

## Introduction

This analysis demonstrates a minimal but functional RNA-seq differential expression workflow. Using gene expression counts from control and irradiated mouse salivary gland tissues, we identify differentially expressed genes (DEGs) with DESeq2 and then perform KEGG pathway enrichment using clusterProfiler. The goal is to understand transcriptomic changes induced by radiation exposure and explore the affected biological pathways.

## 1. Data Import

In this step, we load raw gene count files for three untreated (control) and three irradiated samples. Each file contains raw Ensembl gene counts. The files are merged into a single matrix for input to DESeq2.

```{r}
# Load count files from data/raw/
files <- list.files("../data/raw/", pattern = "GSM.*\\.txt$", full.names = TRUE)
sample_names <- c("UT1", "UT2", "UT3", "IR1", "IR2", "IR3")
names(files) <- sample_names

# Read each count file and merge them on Ensembl gene ID
count_list <- lapply(files, function(f) read_tsv(f, col_names = c("Ensembl", "Count"), show_col_types = FALSE))
counts_merged <- reduce(count_list, function(x, y) inner_join(x, y, by = "Ensembl"))
colnames(counts_merged) <- c("Ensembl", sample_names)

# Convert to matrix and set row names
count_matrix <- counts_merged %>%
  column_to_rownames("Ensembl") %>%
  as.matrix()
```

## 2. DESeq2 Differential Expression Analysis

We perform normalization and differential expression analysis using DESeq2. This step models the count data and estimates log2 fold changes and p-values between control and irradiated conditions.

```{r}
# Define condition metadata
coldata <- data.frame(
  condition = factor(c(rep("Control", 3), rep("Irradiated", 3))),
  row.names = sample_names
)

# Build DESeq2 object and run the pipeline
dds <- DESeqDataSetFromMatrix(countData = count_matrix,
                              colData = coldata,
                              design = ~ condition)
dds <- dds[rowSums(counts(dds)) > 10, ]  # Filter low-count genes
dds <- DESeq(dds)

# Extract results
res <- results(dds, contrast = c("condition", "Irradiated", "Control"))
res_df <- as.data.frame(res) %>%
  rownames_to_column("Ensembl") %>%
  arrange(padj)

# Save results
write.csv(res_df, "../results/deseq2_results.csv")
```

## 3. Volcano Plot of DEGs

We use EnhancedVolcano to visualize DEGs. This highlights genes with both large fold changes and statistical significance.

```{r}
volcano <- EnhancedVolcano(res_df,
                           lab = res_df$Ensembl,
                           x = 'log2FoldChange',
                           y = 'padj',
                           title = 'Irradiated vs Control')

ggsave("../figures/volcano_plot.png", volcano, width = 8, height = 6)
```


## 4. Map Ensembl IDs to Entrez IDs

To use clusterProfiler for KEGG enrichment, we must convert Ensembl gene IDs to Entrez IDs using org.Mm.eg.db.


```{r}
res_df$entrez <- mapIds(org.Mm.eg.db,
                        keys = res_df$Ensembl,
                        column = "ENTREZID",
                        keytype = "ENSEMBL",
                        multiVals = "first")

# Filter for significantly DE genes with valid Entrez IDs
sig_genes <- res_df %>%
  filter(padj < 0.05 & abs(log2FoldChange) > 1) %>%
  pull(entrez) %>%
  na.omit()
```

## 5. KEGG Pathway Enrichment

Using enrichKEGG, we identify biological pathways enriched among significantly differentially expressed genes.

```{r}
kegg <- enrichKEGG(
  gene         = sig_genes,
  organism     = "mmu",   # 'mmu' is the KEGG code for mouse
  pvalueCutoff = 0.05
)

# Save results to CSV
write.csv(as.data.frame(kegg), "../results/kegg_enrichment.csv", row.names = FALSE)
```

## 6. Visualize Top KEGG Pathways

This barplot displays the top 10 enriched KEGG pathways based on adjusted p-values.

```{r}
bar <- barplot(kegg, showCategory = 10, title = "Top Enriched KEGG Pathways")
ggsave("../figures/kegg_barplot.png", plot = bar, width = 8, height = 6)
```

## 7. Heatmap of Highly Variable Genes

We display a heatmap of the top 30 most variable genes across all samples to visualize sample clustering and expression patterns.

```{r}
vsd <- vst(dds, blind = FALSE)
top_genes <- head(order(rowVars(assay(vsd)), decreasing = TRUE), 30)

mat <- assay(vsd)[top_genes, ]
mat <- mat - rowMeans(mat)

heatmap <- pheatmap(mat, cluster_rows = TRUE, cluster_cols = TRUE)
ggsave("../figures/heatmap_top30_genes.png", plot = heatmap[[4]], width = 7, height = 6)
```

